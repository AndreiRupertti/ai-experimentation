const canvas=document.getElementById("board"),ctx=canvas.getContext("2d"),COLORS={COMPONENT_START:"#2d3142",COMPONENT_END:"#1e1e2e",HOOK_START:"#E7DE79",HOOK_END:"#E7DE78",TRIGGER_START:"#FF79C6",TRIGGER_END:"#FF79C7",KEYWORD_BLUE:"#569cd6",TYPE_TEAL:"#4ec9b0",PARAMETER_BLUE:"#9cdcfe",STRING_ORANGE:"#ce9178",INNER_HTML_GRAY:"#888888",COMMENT_GREEN:"#6a9955",FUNCTION_YELLOW:"#dcdcaa",LIGHT_TEXT:"#cccccc",SELECTED_BLUE:"#007acc",SELECTED_CHILD:"#00d4ff",MULTI_SELECTED:"#ff4444",HOVER_BLUE:"#569cd6",HOVER_TOP_LEVEL:"#4a9eff",NORMAL_GRAY:"#3c3c3c",DROP_TARGET:"#00ff88",SHADOW:"rgba(0, 0, 0, 0.3)",SELECTION_AREA:"rgba(100, 149, 237, 0.2)",SELECTION_AREA_BORDER:"#6495ed",SELECTION:"selection",HOVER:"hover"},FONTS={CODE:"bold 16px 'Fira Code', 'Monaco', 'Menlo', monospace",CODE_SMALL:"12px 'Fira Code', 'Monaco', 'Menlo', monospace",CODE_TINY:"11px 'Fira Code', 'Monaco', 'Menlo', monospace",COMMENT:"bold 12px 'Fira Code', sans-serif",EVENT_TITLE:"bold 16px 'Fira Code', 'Monaco', 'Menlo', monospace",EVENT_DESCRIPTION:"12px  'Fira Code', 'Monaco', 'Menlo', monospace",TOGGLE:"bold 16px sans-serif",TYPE_INDICATOR:"10px sans-serif"},LAYOUT={MIN_COMPONENT_WIDTH:200,DEFAULT_COMPONENT_WIDTH:160,DEFAULT_COMPONENT_HEIGHT:40,PADDING_BASE:4,PADDING_LEVEL_MULTIPLIER:20,CHILD_PADDING:30,BORDER_RADIUS:8,SHADOW_OFFSET:2,LINE_HEIGHT:{PROP:20,INNER_HTML:16,INNER_HTML_EMPTY:12,HOOK:14,CHILD:25},TOGGLE_AREA:{x:8,y:8,w:20,h:20},JSX:{TAG_INDENT:20,TAG_VERTICAL_OFFSET:30,TAG_VERTICAL_OFFSET_SELF_CLOSING:40,BRACKET_OFFSET:29,CLOSING_TAG_OFFSET:38,CHAR_WIDTH:10,PROP_SPACING:5,SIMPLE_TAG_RETURN:15,COMPONENT_NAME_SPACING:9,CONTENT_INDENT:25,HOOK_INDENT:35,CLOSING_BRACKET_OFFSET:18,CHILD_INDENT_STEP:20},COMPONENT:{TOGGLE_Y_OFFSET:25,TYPE_INDICATOR_X_OFFSET:70,EVENT_TITLE_X_OFFSET:10,EVENT_TITLE_Y_OFFSET:25,EVENT_DESC_Y_OFFSET:45,NAME_CHAR_WIDTH:12,NAME_BASE_WIDTH:60,HEADER_HEIGHT:60,CLOSING_TAG_SPACING:40,PROP_WIDTH_PADDING:100,CHILD_WIDTH_MARGIN:200},CHILD_JSX:{OFFSET_Y_STEP:20,OFFSET_Y_LARGE_STEP:25,Y_POSITION_OFFSET:18,WIDTH_PADDING:100,NESTED_INDENT_STEP:20,CLOSING_BRACKET_X_OFFSET:18,SIMPLE_CLOSING_X_OFFSET:9},DRAG:{MIN_WIDTH:150,HEIGHT:35,NAME_WIDTH_MULTIPLIER:10,BASE_WIDTH_PADDING:40,SHADOW_OFFSET:3,TEXT_Y_OFFSET:22,ICON_X_OFFSET:20,ICON_Y_OFFSET:20,COMPONENT_NAME_X_OFFSET:19}},CURSORS={DEFAULT:"default",POINTER:"pointer",GRAB:"grab",GRABBING:"grabbing",CROSSHAIR:"crosshair"},COMPONENT_TYPES={COMPONENT:"Component",PROVIDER:"Provider",HOOK:"Hook"},REACT_PATTERNS={CONTAINER:"Container",PRESENTATIONAL:"Presentational",HOC:"HOC",RENDER_PROP:"Render Prop"};function resizeCanvas(){const e=canvas.parentElement.getBoundingClientRect();canvas.style.width="100%",canvas.style.height="100%",canvas.width=e.width,canvas.height=e.height}resizeCanvas(),window.addEventListener("resize",()=>{resizeCanvas(),draw()});let files=[],draggingFile=null,currentDropTarget=null,offsetX=0,offsetY=0,selectedFile=null,selectedChild=null,hoveredFile=null,multiSelectedFiles=[],isAreaSelecting=!1,selectionAreaStart={x:0,y:0},selectionAreaEnd={x:0,y:0},connections=[],isConnecting=!1,connectionStart=null,tempConnectionEnd={x:0,y:0},selectedConnection=null,hoveredConnection=null,history=[],maxHistorySize=30,urlUpdateTimeout=null;const URL_UPDATE_DELAY=300;function saveToURL(){try{const e={files:files,connections:connections,timestamp:(new Date).toISOString()},t=JSON.stringify(e),n=btoa(encodeURIComponent(t)),o=new URL(window.location);o.searchParams.set("state",n),window.history.replaceState({},"",o)}catch(e){console.warn("Failed to save to URL:",e)}}function saveToURLAsync(){urlUpdateTimeout&&clearTimeout(urlUpdateTimeout),urlUpdateTimeout=setTimeout(()=>{saveToURL(),urlUpdateTimeout=null},300)}function loadFromURL(){try{const e=new URL(window.location).searchParams.get("state");if(e){const t=decodeURIComponent(atob(e)),n=JSON.parse(t);return n.files&&(files=n.files),n.connections&&(connections=reconstructConnections(n.connections,files)),console.log("Loaded project from URL state"),!0}}catch(e){console.warn("Failed to load from URL:",e)}return!1}function shareProject(){saveToURL(),navigator.clipboard.writeText(window.location.href).then(()=>{showNotification("Project URL copied to clipboard! Share this link to let others view your canvas.")}).catch(e=>{const t=window.location.href;prompt("Copy this URL to share your project:",t)})}function showNotification(e){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    padding: 12px 20px;\n    border-radius: 8px;\n    font-size: 14px;\n    font-weight: 600;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    z-index: 1000;\n    opacity: 0;\n    transform: translateX(100%);\n    transition: all 0.3s ease;\n  ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},300)},3e3)}const initiallyLoadedFromURL=loadFromURL();initiallyLoadedFromURL||loadFromLocalStorage();let isInitialLoad=initiallyLoadedFromURL;function setCursor(e){canvas.style.cursor=e}function updateCursorForComponent(e,t){if(!e)return void setCursor(isConnecting?CURSORS.CROSSHAIR:CURSORS.DEFAULT);const n=files.includes(e);setCursor(isConnecting?CURSORS.CROSSHAIR:n||t?CURSORS.GRAB:CURSORS.POINTER)}function clearSelection(){selectedFile=null,selectedChild=null,multiSelectedFiles=[]}function isComponentSelected(e){return selectedFile===e||multiSelectedFiles.includes(e)}function addToMultiSelection(e){multiSelectedFiles.includes(e)||multiSelectedFiles.push(e),selectedFile=null,selectedChild=null}function removeFromMultiSelection(e){const t=multiSelectedFiles.indexOf(e);-1!==t&&multiSelectedFiles.splice(t,1)}function isInSelectionArea(e,t,n,o,i){const l=Math.min(t,o),c=Math.max(t,o),r=Math.min(n,i),s=Math.max(n,i);return!(e.x+e.w<l||e.x>c||e.y+e.h<r||e.y>s)}function selectComponentsInArea(e,t,n,o,i){const l=[];function c(e){isInSelectionArea(e,t,n,o,i)&&l.push(e),e.children&&e.children.forEach(e=>c(e))}return e.forEach(e=>c(e)),l}function drawSelectionArea(){if(!isAreaSelecting)return;const e=Math.min(selectionAreaStart.x,selectionAreaEnd.x),t=Math.min(selectionAreaStart.y,selectionAreaEnd.y),n=Math.abs(selectionAreaEnd.x-selectionAreaStart.x),o=Math.abs(selectionAreaEnd.y-selectionAreaStart.y);ctx.fillStyle=COLORS.SELECTION_AREA,ctx.fillRect(e,t,n,o),ctx.strokeStyle=COLORS.SELECTION_AREA_BORDER,ctx.lineWidth=2,ctx.setLineDash([5,5]),ctx.strokeRect(e,t,n,o),ctx.setLineDash([])}function resetConnectionMode(){connectionStart=null,isConnecting=!1,setCursor(CURSORS.DEFAULT);const e=document.getElementById("connectBtn");e&&(e.classList.remove("active"),e.style.background="",e.style.color="")}function connectionExists(e,t){return connections.find(n=>n.from===e&&n.to===t||n.from===t&&n.to===e)}function createConnection(e,t){return{id:Date.now(),from:e,to:t,fromPoint:getConnectionPoint(e,t),toPoint:getConnectionPoint(t,e)}}function createNewComponent(e,t,n){return{name:e,x:t,y:n,w:LAYOUT.DEFAULT_COMPONENT_WIDTH,h:LAYOUT.DEFAULT_COMPONENT_HEIGHT,children:[],expanded:!0,type:COMPONENT_TYPES.COMPONENT,pattern:"",props:[],state:[],hooks:[],events:[],notes:""}}function setFont(e){ctx.font=e}function createGradient(e){let t;return e.isEventBox&&"HOOK"===e.type?(t=ctx.createLinearGradient(e.x,e.y,e.x+e.w,e.y+e.h),t.addColorStop(0,COLORS.HOOK_START),t.addColorStop(1,COLORS.HOOK_END)):e.isEventBox&&"TRIGGER"===e.type?(t=ctx.createLinearGradient(e.x,e.y,e.x+e.w,e.y+e.h),t.addColorStop(0,COLORS.TRIGGER_START),t.addColorStop(1,COLORS.TRIGGER_END)):(t=ctx.createLinearGradient(e.x,e.y,e.x+e.w,e.y+e.h),t.addColorStop(0,COLORS.COMPONENT_START),t.addColorStop(1,COLORS.COMPONENT_END)),t}function drawComponentBorder(e){if(multiSelectedFiles.includes(e))ctx.strokeStyle=COLORS.MULTI_SELECTED,ctx.lineWidth=3,ctx.setLineDash([8,4]);else if(selectedFile===e){files.includes(e)?(ctx.strokeStyle=COLORS.SELECTED_BLUE,ctx.lineWidth=3):(ctx.strokeStyle=COLORS.SELECTED_CHILD,ctx.lineWidth=2,ctx.setLineDash([5,3]))}else if(hoveredFile!==e||draggingFile)ctx.strokeStyle=COLORS.NORMAL_GRAY,ctx.lineWidth=1,ctx.setLineDash([]);else{files.includes(e)?(ctx.strokeStyle=COLORS.HOVER_TOP_LEVEL,ctx.lineWidth=2):(ctx.strokeStyle=COLORS.HOVER_BLUE,ctx.lineWidth=2,ctx.setLineDash([3,3]))}ctx.beginPath(),ctx.roundRect(e.x,e.y,e.w,e.h,LAYOUT.BORDER_RADIUS),ctx.stroke(),ctx.setLineDash([])}function drawShadow(e){ctx.fillStyle=COLORS.SHADOW,ctx.beginPath(),ctx.roundRect(e.x+LAYOUT.SHADOW_OFFSET,e.y+LAYOUT.SHADOW_OFFSET,e.w,e.h,LAYOUT.BORDER_RADIUS),ctx.fill()}function drawWrappedText(e,t,n,o,i=16){const l=e.split("\n");let c=n,r=0;for(let e=0;e<l.length;e++){const n=l[e];if(""===n.trim()){c+=i,r++;continue}const s=n.split(" ");let a="";for(let e=0;e<s.length;e++){const n=a+s[e]+" ";ctx.measureText(n).width>o&&e>0?(ctx.fillText(a,t,c),a=s[e]+" ",c+=i,r++):a=n}a.trim()&&ctx.fillText(a,t,c),e<l.length-1&&(c+=i),r++}return{finalY:c,lineCount:r}}function calculateWrappedTextLines(e,t,n="12px 'Fira Code', 'Monaco', 'Menlo', monospace"){if(!e||!e.trim())return 1;const o=ctx.font;ctx.font=n;const i=e.split("\n");let l=0;for(let e=0;e<i.length;e++){const n=i[e];if(""===n.trim()){l++;continue}const o=n.split(" ");let c="",r=0;for(let e=0;e<o.length;e++){const n=c+o[e]+" ";ctx.measureText(n).width>t&&e>0?(c=o[e]+" ",r++):c=n}r++,l+=r}return ctx.font=o,l}function drawJSXBracket(e,t,n,o=COLORS.KEYWORD_BLUE){ctx.fillStyle=o,ctx.fillText(e,t,n)}function drawJSXComponentName(e,t,n){ctx.fillStyle=COLORS.TYPE_TEAL,ctx.fillText(e,t,n)}function drawJSXProp(e,t,n,o){ctx.fillStyle=COLORS.PARAMETER_BLUE,ctx.fillText(`  ${e}`,n,o);let i=n+ctx.measureText(`  ${e}`).width;ctx.fillStyle=COLORS.KEYWORD_BLUE,ctx.fillText("=",i,o),i+=ctx.measureText("=").width,ctx.fillStyle=COLORS.STRING_ORANGE,ctx.fillText(`{${t}}`,i,o)}function drawJSXSelfClosingTag(e,t,n,o,i=[]){if(setFont(FONTS.CODE),i.length>0){drawJSXBracket("<",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING),drawJSXComponentName(e,t+o+LAYOUT.JSX.BRACKET_OFFSET,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING);let l=LAYOUT.LINE_HEIGHT.PROP+LAYOUT.JSX.PROP_SPACING;i.forEach(e=>{const i=e.value||e.name;drawJSXProp(e.name,i,t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING+l),l+=LAYOUT.LINE_HEIGHT.PROP}),drawJSXBracket("/>",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING+l)}else drawJSXBracket("<",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING),drawJSXComponentName(e,t+o+LAYOUT.JSX.BRACKET_OFFSET,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING),drawJSXBracket(" />",t+o+LAYOUT.JSX.BRACKET_OFFSET+e.length*LAYOUT.JSX.CHAR_WIDTH,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET_SELF_CLOSING)}function drawJSXOpeningTag(e,t,n,o,i=[]){if(setFont(FONTS.CODE),i.length>0){drawJSXBracket("<",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET),drawJSXComponentName(e,t+o+LAYOUT.JSX.BRACKET_OFFSET,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET);let l=LAYOUT.LINE_HEIGHT.PROP+LAYOUT.JSX.PROP_SPACING;return i.forEach(e=>{const i=e.value||e.name;drawJSXProp(e.name,i,t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET+l),l+=LAYOUT.LINE_HEIGHT.PROP}),drawJSXBracket(">",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET+l),l+LAYOUT.LINE_HEIGHT.PROP}return drawJSXBracket("<",t+o+LAYOUT.JSX.TAG_INDENT,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET),drawJSXComponentName(e,t+o+LAYOUT.JSX.BRACKET_OFFSET,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET),drawJSXBracket(">",t+o+LAYOUT.JSX.BRACKET_OFFSET+e.length*LAYOUT.JSX.CHAR_WIDTH,n+LAYOUT.JSX.TAG_VERTICAL_OFFSET),LAYOUT.JSX.SIMPLE_TAG_RETURN}function drawJSXClosingTag(e,t,n,o){drawJSXBracket("</",t+o+LAYOUT.JSX.TAG_INDENT,n),drawJSXComponentName(e,t+o+LAYOUT.JSX.CLOSING_TAG_OFFSET,n),drawJSXBracket(">",t+o+LAYOUT.JSX.CLOSING_TAG_OFFSET+e.length*LAYOUT.JSX.CHAR_WIDTH,n)}function showInputAt(e,t){const n=document.createElement("input");n.type="text",n.style.position="absolute";const o=canvas.getBoundingClientRect();n.style.left=`${o.left+e}px`,n.style.top=`${o.top+t}px`,n.style.font="16px monospace",n.style.padding="2px",n.style.border="1px solid #ccc",n.style.background="white",n.style.zIndex=1e3,document.body.appendChild(n),n.focus(),n.addEventListener("blur",()=>finishInput(n,e,t)),n.addEventListener("keydown",o=>{"Enter"===o.key&&finishInput(n,e,t)})}function finishInput(e,t,n){const o=e.value.trim();try{document.body.removeChild(e)}catch(e){return}if(!o)return;saveState();const i=createNewComponent(o,t,n);files.push(i),draw()}function draw(){if(ctx.clearRect(0,0,canvas.width,canvas.height),files.forEach(e=>{if(e.isEventBox){const t=getParentComponent(e);t&&!t.expanded||drawFile(e,0)}else drawFile(e,0)}),drawConnections(),isConnecting&&connectionStart&&drawTemporaryConnection(),drawSelectionArea(),drawDropTargetIndicators(files),draggingFile){files.includes(draggingFile)||drawDragIndicator(draggingFile)}saveToLocalStorage(),isInitialLoad||saveToURLAsync()}function drawFile(e,t=0){if(draggingFile===e){if(!files.includes(e))return}const n=LAYOUT.PADDING_BASE+t*LAYOUT.PADDING_LEVEL_MULTIPLIER;let o=Math.max(LAYOUT.MIN_COMPONENT_WIDTH,e.name.length*LAYOUT.COMPONENT.NAME_CHAR_WIDTH+LAYOUT.COMPONENT.NAME_BASE_WIDTH);if(e.props&&e.props.length>0&&(setFont(FONTS.CODE),e.props.forEach(e=>{const t=e.value||e.name,n=`  ${e.name}={${t}}`,i=ctx.measureText(n).width;o=Math.max(o,i+LAYOUT.COMPONENT.PROP_WIDTH_PADDING)})),e.children&&e.children.length>0&&e.expanded){const t=calculateMaxChildWidth(e,n+LAYOUT.CHILD_PADDING);o=Math.max(o,t+LAYOUT.COMPONENT.CHILD_WIDTH_MARGIN)}if(e.w=o,e.expanded,updateParentHeight(e),e.isEventBox){const t=60,n=e.w-2*LAYOUT.COMPONENT.EVENT_TITLE_X_OFFSET;if(e.description&&e.description.trim()){const o=14*calculateWrappedTextLines(e.description,n);e.h=t+o-14}else e.h=t}const i=createGradient(e);drawShadow(e),ctx.fillStyle=i,ctx.beginPath(),ctx.roundRect(e.x,e.y,e.w,e.h,LAYOUT.BORDER_RADIUS),ctx.fill(),drawComponentBorder(e),ctx.setLineDash([]);const l=e.children&&e.children.length>0||e.hooks&&e.hooks.length>0||e.innerHtml&&e.innerHtml.trim(),c=files.includes(e);if(l&&c){ctx.fillStyle=COLORS.LIGHT_TEXT,setFont(FONTS.TOGGLE);const t=e.expanded?"▾":"▸";ctx.fillText(t,e.x+LAYOUT.TOGGLE_AREA.x,e.y+LAYOUT.COMPONENT.TOGGLE_Y_OFFSET)}setFont(FONTS.TYPE_INDICATOR);const r=e.type.toUpperCase(),s=ctx.measureText(r).width,a=e.x+e.w-s-10,d=e.y+LAYOUT.JSX.SIMPLE_TAG_RETURN;if(e.isEventBox?ctx.fillStyle="#000000":ctx.fillStyle=COLORS.COMMENT_GREEN,ctx.fillText(r,a,d),e.isEventBox){const t="#2d2d30";if(ctx.fillStyle=t,ctx.font=FONTS.EVENT_TITLE,ctx.fillText(e.name||"Event",e.x+LAYOUT.COMPONENT.EVENT_TITLE_X_OFFSET,e.y+LAYOUT.COMPONENT.EVENT_TITLE_Y_OFFSET),e.description&&e.description.trim()){ctx.fillStyle="#666666",ctx.font=FONTS.EVENT_DESCRIPTION;const t=e.w-2*LAYOUT.COMPONENT.EVENT_TITLE_X_OFFSET;drawWrappedText(e.description,e.x+LAYOUT.COMPONENT.EVENT_TITLE_X_OFFSET,e.y+LAYOUT.COMPONENT.EVENT_DESC_Y_OFFSET,t,14)}return}const f=e.children&&e.children.length>0,u=e.innerHtml&&e.innerHtml.trim();if(f||e.hooks&&0!==e.hooks.length||u){const t=drawJSXOpeningTag(e.name,e.x,e.y,n,e.props||[]);if(e.expanded){let o=e.y+30+t+10;if(e.innerHtml&&e.innerHtml.trim()){ctx.fillStyle=COLORS.INNER_HTML_GRAY,setFont(FONTS.CODE_SMALL);e.innerHtml.split("\n").forEach(t=>{t.trim()?(ctx.fillText(`  ${t}`,e.x+n+LAYOUT.JSX.CONTENT_INDENT,o),o+=LAYOUT.LINE_HEIGHT.INNER_HTML):o+=LAYOUT.LINE_HEIGHT.INNER_HTML_EMPTY}),o+=10}e.hooks&&e.hooks.length>0&&(ctx.fillStyle=COLORS.COMMENT_GREEN,setFont(FONTS.COMMENT),ctx.fillText("// Hooks:",e.x+n+LAYOUT.JSX.CONTENT_INDENT,o),o+=16,e.hooks.forEach(t=>{ctx.fillStyle=COLORS.FUNCTION_YELLOW,setFont(FONTS.CODE_TINY),ctx.fillText(`• ${t}`,e.x+n+LAYOUT.JSX.HOOK_INDENT,o),o+=LAYOUT.LINE_HEIGHT.HOOK}),o+=10),e.children&&e.children.length>0&&(o=drawChildrenAsJSX(e,n+30,o,e.x)),drawJSXClosingTag(e.name,e.x,o,n)}}else drawJSXSelfClosingTag(e.name,e.x,e.y,n,e.props||[])}function exportProject(){const e={name:"React Component Plan",created:(new Date).toISOString(),components:files},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download="react-component-plan.json",o.click()}function importProject(){const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=JSON.parse(e.target.result);t.components&&(files=t.components,draw())}catch(e){alert("Error importing file: "+e.message)}},n.readAsText(t)}),e.click()}function saveToLocalStorage(){try{const e={files:files,connections:connections,timestamp:(new Date).toISOString()};localStorage.setItem("react-component-planner",JSON.stringify(e))}catch(e){console.warn("Failed to save to localStorage:",e)}}function loadFromLocalStorage(){try{const e=localStorage.getItem("react-component-planner");if(e){const t=JSON.parse(e);return t.files&&(files=t.files),t.connections&&(connections=reconstructConnections(t.connections,files)),console.log("Loaded project from localStorage"),!0}}catch(e){console.warn("Failed to load from localStorage:",e)}return!1}function reconstructConnections(e,t){const n=[];const o=function e(t){let n=[];return t.forEach(t=>{n.push(t),t.children&&t.children.length>0&&(n=n.concat(e(t.children)))}),n}(t);function i(e){return o.find(t=>t.name===e.name&&t.x===e.x&&t.y===e.y&&t.type===e.type)}return e.forEach(e=>{const t=i(e.from),o=i(e.to);t&&o?n.push({id:e.id,from:t,to:o,fromPoint:getConnectionPoint(t,o),toPoint:getConnectionPoint(o,t)}):console.warn("Could not reconstruct connection:",e)}),n}function duplicateComponent(e,t,n){const o=function e(t){return{name:t.name,x:t.x+30,y:t.y+30,w:t.w,h:t.h,children:t.children.map(t=>e(t)),expanded:t.expanded,type:t.type,pattern:t.pattern,props:[...t.props||[]],state:[...t.state||[]],hooks:[...t.hooks||[]],events:[...t.events||[]],notes:t.notes||"",notes:t.notes||""}}(e);o.x=t+20,o.y=n+20;const i=findParentOfComponent(e,files);i?i.push(o):files.push(o),selectedFile=o,draw()}function findParentList(e,t){if(t.includes(e))return t;for(const n of t){const t=findParentList(e,n.children);if(t)return t}return null}function repositionChildrenInParent(e){updateParentHeight(e),e.children&&e.children.forEach(e=>{e.children&&e.children.length>0&&repositionChildrenInParent(e)})}function calculateMaxChildWidth(e,t){let n=0;return e.children&&0!==e.children.length?(ctx.font="bold 14px 'Fira Code', 'Monaco', 'Menlo', monospace",e.children.forEach(e=>{let o=t;const i=e.children&&e.children.length>0,l=e.innerHtml&&e.innerHtml.trim(),c=e.props&&e.props.length>0;if(i||l){if(o+=ctx.measureText(`<${e.name}`).width,c){let n=0;e.props&&e.props.length>0&&e.props.forEach(e=>{const t=e.value||e.name,o=`  ${e.name}={${t}}`,i=ctx.measureText(o).width;n=Math.max(n,i)}),o=Math.max(o,t+n)}else o+=ctx.measureText(">").width;const n=t+ctx.measureText(`</${e.name}>`).width;o=Math.max(o,n);const i=calculateMaxChildWidth(e,t+20);o=Math.max(o,i)}else if(c){o+=ctx.measureText(`<${e.name}`).width;let n=0;e.props&&e.props.length>0&&e.props.forEach(e=>{const t=e.value||e.name,o=`  ${e.name}={${t}}`,i=ctx.measureText(o).width;n=Math.max(n,i)}),o=Math.max(o,t+n);const i=t+ctx.measureText("/>").width;o=Math.max(o,i)}else o+=ctx.measureText(`<${e.name} />`).width;n=Math.max(n,o)}),n):n}function calculateComponentHeight(e){let t=50;const n=e.children&&e.children.length>0,o=e.hooks&&e.hooks.length>0,i=e.props&&e.props.length>0,l=n||o;if(i){t+=20*(i?e.props.length:0)+20}return l?(e.expanded&&(o&&(t+=16*e.hooks.length+26),n&&(t+=calculateChildJSXHeight(e)),t+=40),t):t}function calculateChildJSXHeight(e){let t=0;return e.children&&e.children.length>0&&e.children.forEach(e=>{const n=e.children&&e.children.length>0,o=e.innerHtml&&e.innerHtml.trim(),i=e.props&&e.props.length>0;if(n||o){if(i?(t+=20,t+=20*(e.props?e.props.length:0),t+=25):t+=25,o){const n=e.innerHtml.split("\n"),o=n.filter(e=>e.trim()).length,i=n.length-o;t+=16*o+12*i}n&&(t+=calculateChildJSXHeight(e)),t+=25}else i?(t+=20,t+=20*(e.props?e.props.length:0),t+=25):t+=25}),t}function updateParentHeight(e){const t=e.children&&e.children.length>0,n=e.hooks&&e.hooks.length>0,o=e.props&&e.props.length>0,i=e.innerHtml&&e.innerHtml.trim(),l=t||n||i;let c=LAYOUT.COMPONENT.HEADER_HEIGHT;if(o){c+=20*(o?e.props.length:0)+20}if(e.expanded&&l){if(i){const t=e.innerHtml.split("\n"),n=t.filter(e=>e.trim()).length;c+=16*n+12*(t.length-n)+10}n&&(c+=16*e.hooks.length+26),t&&(c+=calculateChildJSXHeight(e)),c+=LAYOUT.COMPONENT.CLOSING_TAG_SPACING,e.h=c}else e.h=c}function saveState(){const e={files:JSON.parse(JSON.stringify(files)),connections:JSON.parse(JSON.stringify(connections)),selectedFile:selectedFile,selectedChild:selectedChild,multiSelectedFiles:[...multiSelectedFiles]};history.push(e),history.length>maxHistorySize&&history.shift()}function undo(){if(0===history.length)return;const e=history.pop();files=e.files,connections=e.connections?reconstructConnections(e.connections,files):[],selectedFile=e.selectedFile,selectedChild=e.selectedChild,multiSelectedFiles=e.multiSelectedFiles||[],draw()}function findFileAtPosition(e,t,n){for(let o=n.length-1;o>=0;o--){const i=n[o];if(i.isEventBox){const e=getParentComponent(i);if(e&&!e.expanded)continue}if(i.children&&i.children.length>0){const n=findFileAtPosition(e,t,i.children);if(n)return n}if(void 0!==i.x&&void 0!==i.y&&void 0!==i.w&&void 0!==i.h&&e>=i.x&&e<=i.x+i.w&&t>=i.y&&t<=i.y+i.h)return i}return null}function findDropTarget(e,t,n,o){if(n.isEventBox)return null;for(const i of o)if(i!==n&&i.children&&i.children.length>0&&!i.isEventBox){const o=findDropTarget(e,t,n,i.children);if(o)return o}for(const i of o)if(i!==n&&!i.isEventBox&&void 0!==i.x&&void 0!==i.y&&void 0!==i.w&&void 0!==i.h&&e>=i.x&&e<=i.x+i.w&&t>=i.y&&t<=i.y+i.h&&!isDescendantOf(i,n))return i;return null}function isDescendantOf(e,t){if(!t.children)return!1;for(const n of t.children){if(n===e)return!0;if(isDescendantOf(e,n))return!0}return!1}function removeFile(e,t){const n=t.indexOf(e);if(-1!==n)return t.splice(n,1),connections=connections.filter(t=>t.from!==e&&t.to!==e),!selectedConnection||selectedConnection.from!==e&&selectedConnection.to!==e||(selectedConnection=null),!0;for(const n of t)if(removeFile(e,n.children))return!0;return!1}function isToggleAt(e,t,n){for(const o of n){if(files.includes(o)){const n={x:o.x+LAYOUT.TOGGLE_AREA.x,y:o.y+LAYOUT.TOGGLE_AREA.y,w:LAYOUT.TOGGLE_AREA.w,h:LAYOUT.TOGGLE_AREA.h};if(e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h)return!0}}return!1}function toggleAt(e,t,n){for(const o of n){if(files.includes(o)){const n={x:o.x+LAYOUT.TOGGLE_AREA.x,y:o.y+LAYOUT.TOGGLE_AREA.y,w:LAYOUT.TOGGLE_AREA.w,h:LAYOUT.TOGGLE_AREA.h};if(e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h)return o.expanded=!o.expanded,o.expanded&&o.children.length>0&&repositionChildrenInParent(o),updateAllParentHeights(files),!0}}return!1}function updateAllParentHeights(e){e.forEach(e=>{e.expanded&&(updateParentHeight(e),e.children.length>0&&updateAllParentHeights(e.children))})}function getMouse(e){const t=canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function drawDropTargetIndicators(e,t=0){e.forEach(e=>{currentDropTarget===e&&draggingFile&&void 0!==e.x&&(ctx.strokeStyle="#00ff88",ctx.lineWidth=3,ctx.setLineDash([8,4]),ctx.shadowColor="#00ff88",ctx.shadowBlur=8,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.beginPath(),ctx.roundRect(e.x,e.y,e.w,e.h,8),ctx.stroke(),ctx.fillStyle="#00ff88",ctx.font="bold 11px sans-serif",ctx.shadowBlur=0,ctx.fillText("📥 Drop here",e.x+e.w-70,e.y+15),ctx.setLineDash([]),ctx.shadowBlur=0),e.children&&drawDropTargetIndicators(e.children,t+1)})}function drawDragIndicator(e){if(!e)return;const t=ctx.globalAlpha;ctx.globalAlpha=.6;const n=Math.max(LAYOUT.DRAG.MIN_WIDTH,e.name.length*LAYOUT.DRAG.NAME_WIDTH_MULTIPLIER+LAYOUT.DRAG.BASE_WIDTH_PADDING),o=LAYOUT.DRAG.HEIGHT,i=e.x,l=e.y;ctx.fillStyle="rgba(0, 0, 0, 0.3)",ctx.beginPath(),ctx.roundRect(i+LAYOUT.DRAG.SHADOW_OFFSET,l+LAYOUT.DRAG.SHADOW_OFFSET,n,o,LAYOUT.BORDER_RADIUS),ctx.fill();let c=ctx.createLinearGradient(i,l,i+n,l+o);c.addColorStop(0,"#2d3142"),c.addColorStop(1,"#1e1e2e"),ctx.fillStyle=c,ctx.beginPath(),ctx.roundRect(i,l,n,o,LAYOUT.BORDER_RADIUS),ctx.fill(),ctx.strokeStyle="#ffffff",ctx.lineWidth=2,ctx.setLineDash([4,2]),ctx.beginPath(),ctx.roundRect(i,l,n,o,LAYOUT.BORDER_RADIUS),ctx.stroke(),ctx.setLineDash([]),ctx.fillStyle="#569cd6",ctx.fillText("<",i+LAYOUT.COMPONENT.EVENT_TITLE_X_OFFSET,l+LAYOUT.DRAG.TEXT_Y_OFFSET),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,i+LAYOUT.DRAG.COMPONENT_NAME_X_OFFSET,l+LAYOUT.DRAG.TEXT_Y_OFFSET),ctx.fillStyle="#569cd6",ctx.fillText(" />",i+LAYOUT.DRAG.COMPONENT_NAME_X_OFFSET+e.name.length*LAYOUT.DRAG.NAME_WIDTH_MULTIPLIER,l+LAYOUT.DRAG.TEXT_Y_OFFSET),ctx.fillStyle="rgba(255, 255, 255, 0.8)",ctx.font="12px sans-serif",ctx.fillText("⌖",i+n-LAYOUT.DRAG.ICON_X_OFFSET,l+LAYOUT.DRAG.ICON_Y_OFFSET),ctx.globalAlpha=t}function drawHighlightBox(e,t,n,o,i){const l=i===COLORS.HOVER;i===COLORS.SELECTION?(ctx.strokeStyle=COLORS.SELECTED_CHILD,ctx.lineWidth=2,ctx.setLineDash([5,3])):l&&(ctx.strokeStyle=COLORS.HOVER_BLUE,ctx.lineWidth=2,ctx.setLineDash([3,3])),ctx.beginPath(),ctx.roundRect(e,t,n,o,LAYOUT.BORDER_RADIUS),ctx.stroke(),ctx.setLineDash([])}function drawChildrenAsJSX(e,t,n,o){let i=n;return e.children&&e.children.length>0&&e.children.forEach(e=>{if(draggingFile===e)return;const n=i,l=e.props&&e.props.length>0,c=e.innerHtml&&e.innerHtml.trim();ctx.font="bold 14px 'Fira Code', 'Monaco', 'Menlo', monospace";let r=t;const s=e.children&&e.children.length>0;if(s||c){if(r+=ctx.measureText(`<${e.name}`).width,l){let n=0;e.props&&e.props.length>0&&e.props.forEach(e=>{const t=e.value||e.name,o=`  ${e.name}={${t}}`,i=ctx.measureText(o).width;n=Math.max(n,i)}),r=Math.max(r,t+n)}else r+=ctx.measureText(">").width;const n=t+ctx.measureText(`</${e.name}>`).width;if(r=Math.max(r,n),e.children&&e.children.length>0){const n=calculateMaxChildWidth(e,t+20);r=Math.max(r,n)}}else if(l){r+=ctx.measureText(`<${e.name}`).width;let n=0;e.props&&e.props.length>0&&e.props.forEach(e=>{const t=e.value||e.name,o=`  ${e.name}={${t}}`,i=ctx.measureText(o).width;n=Math.max(n,i)}),r=Math.max(r,t+n);const o=t+ctx.measureText("/>").width;r=Math.max(r,o)}else r+=ctx.measureText(`<${e.name} />`).width;if(e.x=o+t,e.y=i-18,e.w=r+100,ctx.fillStyle="white",ctx.font="bold 14px 'Fira Code', 'Monaco', 'Menlo', monospace",s||c){if(e.props&&e.props.length>0?(ctx.fillStyle="#569cd6",ctx.fillText("<",e.x,i),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,e.x+9,i),i+=20,e.props&&e.props.length>0&&e.props.forEach(t=>{const n=t.value||t.name;ctx.fillStyle="#9cdcfe",ctx.fillText(`  ${t.name}`,e.x,i);let o=e.x+ctx.measureText(`  ${t.name}`).width;ctx.fillStyle="#569cd6",ctx.fillText("=",o,i),o+=ctx.measureText("=").width,ctx.fillStyle="#ce9178",ctx.fillText(`{${n}}`,o,i),i+=20}),ctx.fillStyle="#569cd6",ctx.fillText(">",e.x,i),i+=25):(ctx.fillStyle="#569cd6",ctx.fillText("<",e.x,i),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,e.x+9,i),ctx.fillStyle="#569cd6",ctx.fillText(">",e.x+9+10*e.name.length,i),i+=25),c){e.innerHtml.split("\n").forEach(t=>{t.trim()?(ctx.fillStyle=COLORS.INNER_HTML_GRAY,ctx.font="14px 'Fira Code', 'Monaco', 'Menlo', monospace",ctx.fillText(`  ${t.trim()}`,e.x,i),i+=25):i+=12})}s&&(i=drawChildrenAsJSX(e,t+20,i,o)),ctx.fillStyle="#569cd6",ctx.fillText("</",e.x,i),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,e.x+18,i),ctx.fillStyle="#569cd6",ctx.fillText(">",e.x+18+10*e.name.length,i),i+=25}else{e.props&&e.props.length>0?(ctx.fillStyle="#569cd6",ctx.fillText("<",e.x,i),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,e.x+9,i),i+=20,e.props&&e.props.length>0&&e.props.forEach(t=>{const n=t.value||t.name;ctx.fillStyle="#9cdcfe",ctx.fillText(`  ${t.name}`,e.x,i);let o=e.x+ctx.measureText(`  ${t.name}`).width;ctx.fillStyle="#569cd6",ctx.fillText("=",o,i),o+=ctx.measureText("=").width,ctx.fillStyle="#ce9178",ctx.fillText(`{${n}}`,o,i),i+=20}),ctx.fillStyle="#569cd6",ctx.fillText("/>",e.x,i),i+=25):(ctx.fillStyle="#569cd6",ctx.fillText("<",e.x,i),ctx.fillStyle="#4ec9b0",ctx.fillText(`${e.name}`,e.x+9,i),ctx.fillStyle="#569cd6",ctx.fillText("/>",e.x+9+10*e.name.length,i),i+=25)}e.h=i-n,selectedFile===e?drawHighlightBox(e.x-2,e.y-2,e.w+4,e.h+4,COLORS.SELECTION):hoveredFile===e&&drawHighlightBox(e.x-2,e.y-2,e.w+4,e.h+4,COLORS.HOVER)}),i}function findParentOfComponent(e,t,n=null){for(const o of t){if(o===e)return{parent:n,list:t};if(o.children&&o.children.length>0){const t=findParentOfComponent(e,o.children,o);if(void 0!==t.parent)return t}}return{parent:void 0,list:null}}function clearCanvas(){confirm("Are you sure you want to clear all components? This cannot be undone.")&&(saveState(),files=[],connections=[],clearSelection(),hoveredFile=null,draw())}function selectToolbar(e){const t=document.querySelectorAll(".toolbar-btn"),n=e=>{t.forEach(t=>{t.id===e?t.classList.add("active"):t.classList.remove("active")})};switch(e){case"connectBtn":toggleConnectionMode(),n(e);break;case"grabBtn":case"pointerBtn":default:n(e);break;case"clearBtn":clearCanvas();case"notesBtn":}}function toggleConnectionMode(){isConnecting=!isConnecting;document.getElementById("connectBtn");isConnecting?(connectionStart=null,canvas.style.cursor="crosshair",selectedFile=null,selectedChild=null,selectedConnection=null):resetConnectionMode(),draw()}function getConnectionPoint(e,t){const n=e.x+e.w/2,o=e.y+e.h/2,i=t.x+t.w/2-n,l=t.y+t.h/2-o,c=Math.atan2(l,i),r=e.w/2,s=e.h/2,a=Math.abs(c),d=Math.atan2(s,r);let f;return f=a<=d?{x:e.x+e.w,y:o+Math.tan(c)*r}:a>=Math.PI-d?{x:e.x,y:o-Math.tan(c)*r}:c>0?{x:n+s/Math.tan(c),y:e.y+e.h}:{x:n-s/Math.tan(c),y:e.y},f}function drawConnections(){connections.forEach(e=>{if(e.to.isEventBox){const t=getParentComponent(e.to);if(t&&!t.expanded)return}e.fromPoint=getConnectionPoint(e.from,e.to),e.toPoint=getConnectionPoint(e.to,e.from),drawArrow(e.fromPoint.x,e.fromPoint.y,e.toPoint.x,e.toPoint.y,e===selectedConnection,e===hoveredConnection)})}function drawTemporaryConnection(){if(!connectionStart)return;const e=getConnectionPoint(connectionStart,{x:tempConnectionEnd.x-50,y:tempConnectionEnd.y-25,w:100,h:50});ctx.save(),ctx.strokeStyle="#666",ctx.lineWidth=2,ctx.setLineDash([5,5]),drawArrow(e.x,e.y,tempConnectionEnd.x,tempConnectionEnd.y,!1,!1,!0),ctx.restore()}function drawArrow(e,t,n,o,i=!1,l=!1,c=!1){ctx.save(),i?(ctx.strokeStyle="white",ctx.lineWidth=3):l?(ctx.strokeStyle="white",ctx.lineWidth=2.5):c?(ctx.strokeStyle="white",ctx.lineWidth=2,ctx.setLineDash([5,5])):(ctx.strokeStyle="white",ctx.lineWidth=2);const r=calculateOrthogonalPath(e,t,n,o);ctx.beginPath(),ctx.moveTo(r[0].x,r[0].y);for(let e=1;e<r.length;e++)ctx.lineTo(r[e].x,r[e].y);ctx.stroke();const s=r[r.length-1],a=r[r.length-2],d=Math.PI/6,f=Math.atan2(s.y-a.y,s.x-a.x);ctx.fillStyle=ctx.strokeStyle,ctx.beginPath(),ctx.moveTo(s.x,s.y),ctx.lineTo(s.x-12*Math.cos(f-d),s.y-12*Math.sin(f-d)),ctx.lineTo(s.x-12*Math.cos(f+d),s.y-12*Math.sin(f+d)),ctx.closePath(),ctx.fill(),ctx.restore()}function calculateOrthogonalPath(e,t,n,o){const i=30,l=[];l.push({x:e,y:t});const c=n-e,r=o-t,s=Math.abs(c),a=Math.abs(r);if(s<5&&a<5)return l.push({x:n,y:o}),l;if(s>i&&a>i)s>a?(l.push({x:e+c/2,y:t}),l.push({x:e+c/2,y:o})):(l.push({x:e,y:t+r/2}),l.push({x:n,y:t+r/2}));else if(s>a)if(s>60){const n=e+c/2;l.push({x:n,y:t}),l.push({x:n,y:o})}else{const o=t+(r>0?i:-30);l.push({x:e,y:o}),l.push({x:n,y:o})}else if(a>60){const o=t+r/2;l.push({x:e,y:o}),l.push({x:n,y:o})}else{const n=e+(c>0?i:-30);l.push({x:n,y:t}),l.push({x:n,y:o})}return l.push({x:n,y:o}),l}function findConnectionAtPosition(e,t){for(const n of connections){const o=calculateOrthogonalPath(n.fromPoint.x,n.fromPoint.y,n.toPoint.x,n.toPoint.y);for(let i=0;i<o.length-1;i++)if(isPointNearLine(e,t,o[i].x,o[i].y,o[i+1].x,o[i+1].y,8))return n}return null}function isPointNearLine(e,t,n,o,i,l,c){const r=e-n,s=t-o,a=i-n,d=l-o,f=r*a+s*d,u=a*a+d*d;if(0===u)return Math.sqrt(r*r+s*s)<=c;let T,p,x=f/u;x<0?(T=n,p=o):x>1?(T=i,p=l):(T=n+x*a,p=o+x*d);const E=e-T,m=t-p;return Math.sqrt(E*E+m*m)<=c}function openConfigDrawer(e){const t=document.getElementById("configDrawer"),n=document.getElementById("drawerTitle"),o=document.getElementById("componentConfigContent"),i=document.getElementById("eventConfigContent");if(t.classList.add("open"),e.isEventBox)n.textContent="Hook Configuration",o.style.display="none",i.style.display="block",document.getElementById("eventBoxName").value=e.name||"",document.getElementById("eventBoxDescription").value=e.description||"";else{n.textContent="Component Configuration",i.style.display="none",o.style.display="block",document.getElementById("componentName").value=e.name,document.getElementById("innerHtml").value=e.innerHtml||"";document.getElementById("propsList").innerHTML="",e.props&&e.props.length>0&&e.props.forEach((e,t)=>{addPropToDOM(e.name,e.value||"",t)});document.getElementById("eventsList").innerHTML="",e.events&&e.events.length>0&&e.events.forEach((e,t)=>{addEventToDOM(e.name,e.description||"",t)});document.getElementById("hookInputsList").innerHTML="";document.getElementById("triggerInputsList").innerHTML="",displayConnectedHooks(e),displayConnectedTriggers(e)}}function closeConfigDrawer(){document.getElementById("configDrawer").classList.remove("open")}function updateEventBoxName(){if(!selectedFile||!selectedFile.isEventBox)return;const e=document.getElementById("eventBoxName").value.trim();e!==selectedFile.name&&(saveState(),selectedFile.name=e,draw())}function updateEventBoxDescription(){if(!selectedFile||!selectedFile.isEventBox)return;const e=document.getElementById("eventBoxDescription").value;e!==selectedFile.description&&(saveState(),selectedFile.description=e,draw())}function updateComponentName(){if(!selectedFile)return;const e=document.getElementById("componentName").value.trim();e&&e!==selectedFile.name&&(saveState(),selectedFile.name=e,draw())}function updateInnerHtml(){if(!selectedFile)return;const e=document.getElementById("innerHtml").value;e!==(selectedFile.innerHtml||"")&&(saveState(),selectedFile.innerHtml=e,draw())}function addProp(){if(!selectedFile)return;addPropToDOM("","",selectedFile.props?selectedFile.props.length:0),updateParentHeight(selectedFile);const e=findParentOfComponent(selectedFile,files);e.parent&&repositionChildrenInParent(e.parent),draw()}function addPropToDOM(e,t,n){const o=document.getElementById("propsList"),i=document.createElement("div");i.className="prop-item",i.innerHTML=`\n    <input type="text" class="form-input" placeholder="Prop name" value="${e}" \n           onchange="updateProp(${n}, 'name', this.value)">\n    <input type="text" class="form-input prop-value" placeholder="Value (optional)" value="${t}" \n           onchange="updateProp(${n}, 'value', this.value)">\n    <button class="remove-btn" onclick="removeProp(${n})">×</button>\n  `,o.appendChild(i),selectedFile&&(selectedFile.props||(selectedFile.props=[]),selectedFile.props[n]||(selectedFile.props[n]={name:e,value:t}))}function updateProp(e,t,n){if(!selectedFile||!selectedFile.props||!selectedFile.props[e])return;saveState(),selectedFile.props[e][t]=n,updateParentHeight(selectedFile);const o=findParentOfComponent(selectedFile,files);o.parent&&repositionChildrenInParent(o.parent),draw()}function removeProp(e){if(!selectedFile||!selectedFile.props)return;saveState(),selectedFile.props.splice(e,1),updateParentHeight(selectedFile);const t=findParentOfComponent(selectedFile,files);t.parent&&repositionChildrenInParent(t.parent),openConfigDrawer(selectedFile),draw()}function addHookInput(){if(!selectedFile)return;addHookInputToDOM("","",0)}function addHookInputToDOM(e,t,n){const o=document.getElementById("hookInputsList"),i=document.createElement("div");i.className="hook-input-container",i.style.cssText="\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    padding: 10px;\n    border: 1px solid #444;\n    border-radius: 4px;\n    margin-bottom: 10px;\n  ",i.innerHTML=`\n    <div style="display: flex; flex-direction: column;">\n      <input type="text" class="form-input" placeholder="Hook name" value="${e}" \n             id="hookName_${n}" style="width: 100%; margin-bottom: 0;">\n    </div>\n    <div style="display: flex; flex-direction: column;">\n      <input type="text" class="form-input" placeholder="Description" value="${t}" \n             id="hookDescription_${n}" style="width: 100%; margin-bottom: 0;">\n    </div>\n    <div style="display: flex; justify-content: flex-end; gap: 10px;">\n      <button class="secondary-btn" onclick="removeHookInput(${n})">Cancel</button>\n      <button class="add-btn" onclick="createHookFromInput(${n})">Save</button>\n    </div>\n  `,o.appendChild(i)}function removeHookInput(e){const t=document.getElementById("hookInputsList").getElementsByClassName("hook-input-container");t[e]&&t[e].remove()}function createHookFromInput(e){if(!selectedFile)return;const t=document.getElementById(`hookName_${e}`),n=document.getElementById(`hookDescription_${e}`);if(!t||!n)return;const o=t.value.trim()||"useHook",i=n.value.trim()||"Hook event description";saveState();const l={name:o,description:i,x:selectedFile.x+selectedFile.w+250,y:selectedFile.y+0,w:200,h:60,type:"HOOK",isEventBox:!0,parentComponent:null};files.push(l);const c={id:Date.now(),from:selectedFile,to:l,fromPoint:getConnectionPoint(selectedFile,l),toPoint:getConnectionPoint(l,selectedFile)};connections.push(c),removeHookInput(e),displayConnectedHooks(selectedFile),displayConnectedTriggers(selectedFile),draw()}function addTriggerInput(){if(!selectedFile)return;addTriggerInputToDOM("","",0)}function addTriggerInputToDOM(e,t,n){const o=document.getElementById("triggerInputsList"),i=document.createElement("div");i.className="trigger-input-container",i.style.cssText="\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    padding: 10px;\n    border: 1px solid #444;\n    border-radius: 4px;\n    margin-bottom: 10px;\n  ",i.innerHTML=`\n    <div style="display: flex; flex-direction: column;">\n      <input type="text" class="form-input" placeholder="Trigger Name (eg. onClick)" value="${e}" \n             id="triggerName_${n}" style="width: 100%; margin-bottom: 0;">\n    </div>\n    <div style="display: flex; flex-direction: column;">\n      <textarea type="textarea" rows="3" class="form-input" placeholder="eg.\n1. Call API\n2. Toast Notification " value="${t}" \n             id="triggerActions_${n}" style="width: 100%; margin-bottom: 0;"></textarea>\n    </div>\n    <div style="display: flex; justify-content: flex-end; gap: 10px;">\n      <button class="secondary-btn" onclick="removeTriggerInput(${n})">Cancel</button>\n      <button class="add-btn" onclick="createTriggerFromInput(${n})">Save</button>\n    </div>\n  `,o.appendChild(i)}function removeTriggerInput(e){const t=document.getElementById("triggerInputsList").getElementsByClassName("trigger-input-container");t[e]&&t[e].remove()}function createTriggerFromInput(e){if(!selectedFile)return;const t=document.getElementById(`triggerName_${e}`),n=document.getElementById(`triggerActions_${e}`);if(!t||!n)return;const o=t.value.trim()||"NewTrigger",i=n.value.trim()||"1. Handler";saveState();const l={name:o,description:i,x:selectedFile.x+selectedFile.w+250,y:selectedFile.y+60,w:200,h:60,type:"TRIGGER",isEventBox:!0,parentComponent:null};files.push(l);const c={id:Date.now(),from:selectedFile,to:l,fromPoint:getConnectionPoint(selectedFile,l),toPoint:getConnectionPoint(l,selectedFile)};connections.push(c),removeTriggerInput(e),displayConnectedHooks(selectedFile),displayConnectedTriggers(selectedFile),draw()}function getConnectedEventBoxes(e,t){const n=[];return connections.forEach(o=>{o.from===e&&o.to.isEventBox&&o.to.type===t&&n.push({eventBox:o.to,connection:o})}),n}function getParentComponent(e){if(!e.isEventBox)return null;const t=connections.find(t=>t.to===e);return t?t.from:null}function displayConnectedHooks(e){const t=getConnectedEventBoxes(e,"HOOK"),n=document.getElementById("connectedHooksList");if(n){if(n.innerHTML="",0===t.length){const e=document.createElement("div");return e.style.cssText="\n      color: #888;\n      font-style: italic;\n      font-size: 12px;\n      padding: 8px 0;\n    ",e.textContent="No hooks connected",void n.appendChild(e)}t.forEach((e,t)=>{const o=document.createElement("div");o.className="connected-item",o.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 8px 12px;\n      margin-bottom: 6px;\n      background: rgba(255, 214, 10, 0.1);\n      border: 1px solid rgba(255, 214, 10, 0.3);\n      border-radius: 6px;\n      font-size: 14px;\n    ",o.innerHTML=`\n      <span class="connected-name" style="color: #b8860b; font-weight: 600;">${e.eventBox.name}</span>\n      <button class="remove-btn" onclick="removeConnectedHook('${e.connection.id}')" title="Remove hook connection" style="\n        background: #ff6b6b;\n        color: white;\n        border: none;\n        border-radius: 4px;\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        font-size: 12px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ">×</button>\n    `,n.appendChild(o)})}}function displayConnectedTriggers(e){const t=getConnectedEventBoxes(e,"TRIGGER"),n=document.getElementById("connectedTriggersList");if(n){if(n.innerHTML="",0===t.length){const e=document.createElement("div");return e.style.cssText="\n      color: #888;\n      font-style: italic;\n      font-size: 12px;\n      padding: 8px 0;\n    ",e.textContent="No triggers connected",void n.appendChild(e)}t.forEach((e,t)=>{const o=document.createElement("div");o.className="connected-item",o.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 8px 12px;\n      margin-bottom: 6px;\n      background: rgba(255, 107, 157, 0.1);\n      border: 1px solid rgba(255, 107, 157, 0.3);\n      border-radius: 6px;\n      font-size: 14px;\n    ",o.innerHTML=`\n      <span class="connected-name" style="color: #d63384; font-weight: 600;">${e.eventBox.name}</span>\n      <button class="remove-btn" onclick="removeConnectedTrigger('${e.connection.id}')" title="Remove trigger connection" style="\n        background: #ff6b6b;\n        color: white;\n        border: none;\n        border-radius: 4px;\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        font-size: 12px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ">×</button>\n    `,n.appendChild(o)})}}function removeConnectedHook(e){saveState();const t=connections.findIndex(t=>t.id.toString()===e);if(-1!==t){const e=connections[t],n=files.findIndex(t=>t===e.to);-1!==n&&files.splice(n,1),connections.splice(t,1),selectedFile&&(displayConnectedHooks(selectedFile),displayConnectedTriggers(selectedFile)),draw()}}function removeConnectedTrigger(e){saveState();const t=connections.findIndex(t=>t.id.toString()===e);if(-1!==t){const e=connections[t],n=files.findIndex(t=>t===e.to);-1!==n&&files.splice(n,1),connections.splice(t,1),selectedFile&&(displayConnectedHooks(selectedFile),displayConnectedTriggers(selectedFile)),draw()}}draw(),setTimeout(()=>{isInitialLoad=!1},100),canvas.addEventListener("dblclick",e=>{const{x:t,y:n}=getMouse(e);if(isToggleAt(t,n,files))return;findFileAtPosition(t,n,files)||showInputAt(t,n)}),canvas.addEventListener("mousedown",e=>{const{x:t,y:n}=getMouse(e);if(isConnecting){const e=findFileAtPosition(t,n,files);if(e)if(connectionStart){if(e!==connectionStart){if(!connections.find(t=>t.from===connectionStart&&t.to===e||t.from===e&&t.to===connectionStart)){const t={id:Date.now(),from:connectionStart,to:e,fromPoint:getConnectionPoint(connectionStart,e),toPoint:getConnectionPoint(e,connectionStart)};connections.push(t),saveState()}resetConnectionMode()}}else connectionStart=e,tempConnectionEnd={x:t,y:n};else resetConnectionMode();return void draw()}const o=findConnectionAtPosition(t,n);if(o)return selectedConnection=o,clearSelection(),void draw();const i=findFileAtPosition(t,n,files);if(i&&!e.ctrlKey&&!e.metaKey){const e=files.includes(i),o=isComponentSelected(i);return multiSelectedFiles.includes(i)?(draggingFile=i,offsetX=t-draggingFile.x,offsetY=n-draggingFile.y,currentDropTarget=null,void draw()):(clearSelection(),selectedFile=i,selectedChild=e?null:i,e||o?(draggingFile=i,offsetX=t-draggingFile.x,offsetY=n-draggingFile.y,currentDropTarget=null,void draw()):void draw())}if(i&&(e.ctrlKey||e.metaKey))return multiSelectedFiles.includes(i)?removeFromMultiSelection(i):addToMultiSelection(i),void draw();e.ctrlKey||e.metaKey||clearSelection(),isAreaSelecting=!0,selectionAreaStart={x:t,y:n},selectionAreaEnd={x:t,y:n},selectedConnection=null}),canvas.addEventListener("mousemove",e=>{const{x:t,y:n}=getMouse(e);if(isConnecting&&connectionStart)return tempConnectionEnd={x:t,y:n},void draw();if(isAreaSelecting)return selectionAreaEnd={x:t,y:n},void draw();if(!draggingFile){const e=findFileAtPosition(t,n,files),o=findConnectionAtPosition(t,n);if(o!==hoveredConnection&&(hoveredConnection=o,draw()),e!==hoveredFile){if(hoveredFile=e,hoveredFile){updateCursorForComponent(hoveredFile,hoveredFile===selectedFile)}else setCursor(isConnecting?CURSORS.CROSSHAIR:hoveredConnection?CURSORS.POINTER:CURSORS.DEFAULT);draw()}return}const o=t-offsetX-draggingFile.x,i=n-offsetY-draggingFile.y;draggingFile.x=t-offsetX,draggingFile.y=n-offsetY,multiSelectedFiles.includes(draggingFile)&&multiSelectedFiles.forEach(e=>{e!==draggingFile&&(e.x+=o,e.y+=i)}),setCursor(CURSORS.GRABBING),currentDropTarget=draggingFile.isEventBox||multiSelectedFiles.length>0?null:findDropTarget(t,n,draggingFile,files),draw()}),canvas.addEventListener("mouseup",e=>{const{x:t,y:n}=getMouse(e);if(isAreaSelecting){const t=selectComponentsInArea(files,selectionAreaStart.x,selectionAreaStart.y,selectionAreaEnd.x,selectionAreaEnd.y);return t.length>0?e.ctrlKey||e.metaKey?t.forEach(e=>addToMultiSelection(e)):(clearSelection(),multiSelectedFiles=[...t]):e.ctrlKey||e.metaKey||clearSelection(),void(isAreaSelecting=!1)}if(!draggingFile)return;if(saveState(),multiSelectedFiles.length>0){draggingFile=null,currentDropTarget=null;const e=findFileAtPosition(t,n,files);if(e){const t=files.includes(e),n=isComponentSelected(e);canvas.style.cursor=t||n?"grab":"pointer"}else canvas.style.cursor="default";return void draw()}let o=null;if(draggingFile.isEventBox||(o=findDropTarget(t,n,draggingFile,files)),o){const e=findParentOfComponent(draggingFile,files);e.parent?(removeFile(draggingFile,e.list),updateParentHeight(e.parent),repositionChildrenInParent(e.parent)):removeFile(draggingFile,files),o.children.push(draggingFile),repositionChildrenInParent(o)}else{if(!files.includes(draggingFile)){const e=findParentOfComponent(draggingFile,files);e.parent&&e.list&&(removeFile(draggingFile,e.list),files.push(draggingFile),updateParentHeight(e.parent),repositionChildrenInParent(e.parent),draggingFile.x=t-offsetX,draggingFile.y=n-offsetY)}}draggingFile=null,currentDropTarget=null;const i=findFileAtPosition(t,n,files);if(i){const e=files.includes(i),t=i===selectedFile;canvas.style.cursor=e||t?"grab":"pointer"}else canvas.style.cursor="default";draw()}),canvas.addEventListener("click",e=>{const{x:t,y:n}=getMouse(e);if(currentDropTarget=null,toggleAt(t,n,files))return saveState(),void draw();if((e.ctrlKey||e.metaKey)&&!e.shiftKey){const e=findFileAtPosition(t,n,files);if(e&&0===multiSelectedFiles.length)return saveState(),void duplicateComponent(e,t,n)}0===multiSelectedFiles.length&&selectedFile?openConfigDrawer(selectedFile):0===multiSelectedFiles.length&&closeConfigDrawer(),draw()}),document.addEventListener("keydown",e=>{const t=document.getElementById("configDrawer");if(!(t&&t.contains(e.target)||"INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)){if((e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),exportProject()),(e.ctrlKey||e.metaKey)&&"o"===e.key&&(e.preventDefault(),importProject()),(e.ctrlKey||e.metaKey)&&"z"===e.key&&(e.preventDefault(),undo()),"c"!==e.key&&"C"!==e.key||(e.preventDefault(),toggleConnectionMode()),"Delete"===e.key||"Backspace"===e.key)if(e.preventDefault(),selectedConnection)saveState(),connections=connections.filter(e=>e!==selectedConnection),selectedConnection=null,draw();else if(multiSelectedFiles.length>0){saveState();[...multiSelectedFiles].forEach(e=>{const t=findParentOfComponent(e,files);if(t.parent){const n=t.parent.children.indexOf(e);-1!==n&&(t.parent.children.splice(n,1),updateParentHeight(t.parent),repositionChildrenInParent(t.parent))}else{const t=files.indexOf(e);-1!==t&&files.splice(t,1)}connections=connections.filter(t=>t.from!==e&&t.to!==e)}),clearSelection(),hoveredFile=null,closeConfigDrawer(),draw()}else selectedFile&&(saveState(),removeFile(selectedFile,files),clearSelection(),hoveredFile=null,closeConfigDrawer(),draw());if("Escape"===e.key){const e=document.getElementById("configDrawer");e&&e.classList.contains("open")&&closeConfigDrawer(),isConnecting&&resetConnectionMode(),selectedFile=null,selectedChild=null,selectedConnection=null,multiSelectedFiles=[],draw()}}}),canvas.addEventListener("mouseleave",e=>{canvas.style.cursor="default",hoveredFile=null,draw()}),draw(),document.getElementById("shareBtn").addEventListener("click",()=>{shareProject()}),document.getElementById("exportBtn").addEventListener("click",()=>{exportProject()}),document.getElementById("importBtn").addEventListener("click",()=>{importProject()}),document.getElementById("pointerBtn").addEventListener("click",()=>{selectToolbar("pointerBtn")}),document.getElementById("connectBtn").addEventListener("click",()=>{selectToolbar("connectBtn")}),document.getElementById("notesBtn").addEventListener("click",()=>{selectToolbar("notesBtn")}),document.getElementById("clearBtn").addEventListener("click",()=>{selectToolbar("clearBtn")}),document.getElementById("closeDrawerBtn").addEventListener("click",()=>{closeConfigDrawer()}),document.getElementById("addPropBtn").addEventListener("click",()=>{addProp()}),document.getElementById("addHookInputBtn").addEventListener("click",()=>{addHookInput()}),document.getElementById("addTriggerInputBtn").addEventListener("click",()=>{addTriggerInput()}),document.getElementById("componentName").addEventListener("change",()=>{updateComponentName()}),document.getElementById("innerHtml").addEventListener("change",()=>{updateInnerHtml()}),document.getElementById("eventBoxName").addEventListener("change",()=>{updateEventBoxName()}),document.getElementById("eventBoxDescription").addEventListener("change",()=>{updateEventBoxDescription()}),window.addEventListener("beforeunload",()=>{urlUpdateTimeout&&(clearTimeout(urlUpdateTimeout),saveToURL())});